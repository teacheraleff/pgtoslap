<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Seguro - Asaas Payment</title>
    <!-- Carrega Tailwind CSS para estiliza√ß√£o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configura√ß√£o da fonte DM Sans (SLAP Font) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap');
        body {
            font-family: 'DM Sans', sans-serif;
            background-color: #18181b; /* Fundo escuro (zinc-900) */
            min-height: 100vh;
        }
        /* Cor de destaque SLAP: Amarelo (yellow-500/400) */
        .slap-accent {
            background-color: #f59e0b; /* yellow-600 */
            color: #18181b; /* zinc-900 */
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- HEADER -->
        <header class="py-6 border-b border-zinc-700 mb-8">
            <div class="flex flex-col items-center justify-center">
                <!-- LOGO SLAP (Placeholder com o Amarelo de destaque) -->
                <div class="text-4xl font-extrabold tracking-widest px-4 py-1 rounded-lg bg-yellow-500 text-zinc-900 shadow-xl shadow-yellow-900/50">SLAP</div>
                
                <h1 class="text-3xl font-extrabold text-white text-center mt-4">Finalizar Pedido</h1>
                <p class="text-center text-zinc-400">Seu gateway de pagamento seguro integrado ao Asaas.</p>
            </div>
        </header>

        <!-- CONTAINER PRINCIPAL: GRID RESPONSIVO (2 colunas em desktop, 1 coluna em mobile) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- COLUNA 1: INFORMA√á√ïES DO CLIENTE E PAGAMENTO (2/3 da largura no desktop) -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- 1. ESPA√áO PARA CLIENTES PREENCHEREM -->
                <section id="customer-info-section" class="bg-zinc-800 p-6 rounded-xl shadow-xl border border-zinc-700">
                    <h2 class="text-xl font-semibold text-white mb-4 border-b border-zinc-700 pb-2">Informa√ß√µes Pessoais</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="customer-name" class="block text-sm font-medium text-zinc-300 mb-1">Nome Completo</label>
                            <input type="text" id="customer-name" placeholder="Nome Completo" 
                                class="w-full p-3 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-blue-500 bg-zinc-900 text-white">
                        </div>
                        <div>
                            <label for="customer-email" class="block text-sm font-medium text-zinc-300 mb-1">E-mail</label>
                            <input type="email" id="customer-email" placeholder="seu@email.com" 
                                class="w-full p-3 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-blue-500 bg-zinc-900 text-white">
                        </div>
                        <div>
                            <label for="customer-cpf" class="block text-sm font-medium text-zinc-300 mb-1">CPF</label>
                            <input type="text" id="customer-cpf" placeholder="000.000.000-00" 
                                class="w-full p-3 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-blue-500 bg-zinc-900 text-white">
                        </div>
                         <!-- CAMPO: Data de Nascimento (Agora √© um seletor de calend√°rio nativo) -->
                        <div>
                            <label for="customer-dob" class="block text-sm font-medium text-zinc-300 mb-1">Data de Nascimento</label> 
                            <input type="date" id="customer-dob" 
                                class="w-full p-3 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-blue-500 bg-zinc-900 text-white">
                        </div>
                    </div>
                </section>

                <!-- 2. MODO DE PAGAMENTO -->
                <section id="payment-method-section" class="bg-zinc-800 p-6 rounded-xl shadow-xl border border-zinc-700">
                    <h2 class="text-xl font-semibold text-white mb-4 border-b border-zinc-700 pb-2">Selecione o M√©todo de Pagamento</h2>
                    
                    <div class="flex flex-col sm:flex-row gap-4">
                        <!-- PIX -->
                        <div class="flex-1">
                            <input type="radio" id="method-pix" name="payment-method" value="PIX" checked class="hidden peer">
                            <label for="method-pix" class="flex items-center justify-between p-4 border-2 border-green-500 rounded-xl cursor-pointer peer-checked:bg-green-900/50 peer-checked:ring-2 peer-checked:ring-green-500 transition-all duration-200">
                                <span class="font-bold text-green-300">PIX (Recomendado)</span>
                                <!-- SVG Icone PIX (Simples) -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><rect width="20" height="14" x="2" y="5" rx="2"/><path d="M7 15h0.01"/></svg>
                            </label>
                        </div>
                        
                        <!-- CART√ÉO DE CR√âDITO -->
                        <div class="flex-1">
                            <input type="radio" id="method-card" name="payment-method" value="CREDIT_CARD" class="hidden peer">
                            <label for="method-card" class="flex items-center justify-between p-4 border-2 border-zinc-700 rounded-xl cursor-pointer peer-checked:bg-blue-900/50 peer-checked:ring-2 peer-checked:ring-blue-500 transition-all duration-200">
                                <span class="font-bold text-blue-300">Cart√£o de Cr√©dito</span>
                                <!-- SVG Icone Cart√£o -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
                            </label>
                        </div>
                    </div>
                </section>

                <!-- SELETOR DE PARCELAS (Aparece SOMENTE para Cart√£o de Cr√©dito) -->
                <section id="installments-section" class="bg-zinc-800 p-6 rounded-xl shadow-xl border border-zinc-700 hidden">
                    <h2 class="text-xl font-semibold text-white mb-4 border-b border-zinc-700 pb-2">Op√ß√µes de Parcelamento</h2>
                    <div>
                        <label for="installments" class="block text-sm font-medium text-zinc-300 mb-1">N√∫mero de Parcelas</label>
                        <select id="installments" class="w-full p-3 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-blue-500 bg-zinc-900 text-white">
                            <!-- Op√ß√µes ser√£o preenchidas dinamicamente pelo JavaScript -->
                        </select>
                        <p class="text-xs text-zinc-400 mt-2">Valores s√£o calculados com base no pre√ßo total. O c√°lculo final de juros deve ser configurado no seu backend.</p>
                    </div>
                </section>
                
                <!-- √ÅREA DE MENSAGEM DE STATUS (Para mobile) -->
                <div id="status-message-container-mobile" class="lg:hidden mt-6 p-3 bg-zinc-700 rounded-lg text-center hidden">
                    <p id="status-message-mobile" class="text-zinc-200 font-medium"></p>
                </div>

                <!-- Bot√£o de Pagamento para Mobile -->
                <button id="payment-button-mobile" onclick="handlePayment()" 
                    class="lg:hidden mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white text-lg font-bold py-4 rounded-xl transition-all duration-300 shadow-xl shadow-blue-900/50">
                    Gerar Pagamento Asaas
                </button>
            </div>

            <!-- COLUNA 2: RESUMO DA COMPRA (SIDE BOX) (1/3 da largura no desktop) -->
            <div class="lg:col-span-1">
                <div class="bg-zinc-800 p-6 rounded-xl shadow-2xl sticky top-8 border border-zinc-700">
                    
                    <h2 class="text-xl font-bold text-white mb-4 border-b border-zinc-700 pb-2">Resumo da Compra</h2>
                    
                    <!-- BOX LATERAL: O QUE INCLUI NESSA COMPRA -->
                    <div id="product-info-summary" class="mb-6 space-y-3">
                        <p class="font-semibold text-lg text-white" id="product-name">Carregando...</p>
                        <ul id="product-features" class="text-sm text-zinc-400 space-y-1 ml-4 list-disc">
                            <!-- Features carregadas dinamicamente -->
                            <li>Acesso vital√≠cio ao conte√∫do</li>
                        </ul>
                    </div>

                    <!-- BOT√ÉO DE CONFIGURA√á√ÉO (VIS√çVEL APENAS PARA ADMIN) -->
                    <div id="admin-setup-box" class="mb-6 pt-4 border-t border-zinc-700">
                        <p class="text-sm text-yellow-500 mb-2 font-medium">üõ†Ô∏è Configura√ß√£o Inicial do Admin</p>
                        <button id="setup-data-btn" onclick="setInitialData()" disabled
                            class="w-full bg-yellow-700/50 hover:bg-yellow-700 text-yellow-200 font-bold py-2 rounded-lg transition-colors text-sm disabled:opacity-50">
                            Configurar Pre√ßo e Cupons Iniciais
                        </button>
                    </div>
                    
                    <!-- ESPA√áO PARA CUPOM -->
                    <div class="mb-6 pt-4 border-t border-zinc-700">
                        <label for="coupon-input" class="block text-sm font-medium text-zinc-300 mb-2">Cupom de Desconto</label>
                        <div class="flex space-x-2">
                            <input type="text" id="coupon-input" placeholder="C√ìDIGO" 
                                class="flex-1 p-2 border border-zinc-700 rounded-lg focus:ring-2 focus:ring-yellow-400 uppercase transition-colors bg-zinc-900 text-white"
                                oninput="document.getElementById('coupon-message').textContent = ''">
                            <button id="apply-coupon-btn" onclick="applyCoupon()" 
                                class="bg-yellow-500 hover:bg-yellow-400 text-zinc-900 font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 shadow-md shadow-yellow-900/50">
                                Aplicar
                            </button>
                        </div>
                        <p id="coupon-message" class="mt-2 text-sm h-5"></p>
                    </div>

                    <!-- RESUMO DO PRE√áO -->
                    <div class="space-y-3 pt-4 border-t border-zinc-700">
                        <div class="flex justify-between text-zinc-300">
                            <span>Pre√ßo Base:</span>
                            <span id="original-price-display" class="font-medium">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between text-zinc-300">
                            <span>Desconto Aplicado:</span>
                            <span id="discount-display" class="font-medium text-green-400">- R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center text-2xl font-bold border-t pt-3 border-zinc-700">
                            <span>Total:</span>
                            <span id="total-price-display" class="text-blue-500">R$ 0,00</span>
                        </div>
                    </div>
                    
                    <!-- Bot√£o de Pagamento para Desktop -->
                    <button id="payment-button-desktop" onclick="handlePayment()" 
                        class="hidden lg:block mt-8 w-full bg-blue-600 hover:bg-blue-700 text-white text-lg font-bold py-4 rounded-xl transition-all duration-300 shadow-xl shadow-blue-900/50">
                        Gerar Pagamento Asaas
                    </button>

                    <!-- √ÅREA DE MENSAGEM DE STATUS (Para desktop) -->
                    <div id="status-message-container-desktop" class="hidden lg:block mt-6 p-3 bg-zinc-700 rounded-lg text-center hidden">
                        <p id="status-message-desktop" class="text-zinc-200 font-medium"></p>
                    </div>
                     <!-- Status de Conex√£o Firebase -->
                    <div id="firebase-status" class="mt-4 text-xs text-center text-zinc-500">
                        Status do DB: Conectando...
                    </div>

                </div>
            </div>
            
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            setLogLevel,
            query, 
            getDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vari√°veis de Ambiente e Inicializa√ß√£o
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Vari√°veis de Estado Global
        let db;
        let auth;
        let userId = 'anon';
        let isAuthReady = false;
        
        let originalPrice = 0.00; // Pre√ßo base lido do Firestore
        let currentDiscount = 0;
        let finalPrice = 0.00;
        let COUPON_DATA = {}; // Cupons lidos do Firestore

        // Constantes do Firestore
        const PUBLIC_DATA_PATH = `/artifacts/${appId}/public/data`;
        const CONFIG_DOC_PATH = `${PUBLIC_DATA_PATH}/config/product_config`;
        const COUPONS_COLLECTION_PATH = `${PUBLIC_DATA_PATH}/coupons`;
        
        // ENDPOINT PARA SEU SERVIDOR SEGURO (Netlify Function, Cloud Function, etc.)
        const ASAAS_BACKEND_ENDPOINT = '/.netlify/functions/asaas-payment-function'; // CORRE√á√ÉO: Padr√£o Netlify Functions
        
        // ------------------------------------
        // FIREBASE SETUP E LISTENERS
        // ------------------------------------

        /**
         * Inicializa o Firebase e configura a autentica√ß√£o.
         */
        const initializeFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                document.getElementById('firebase-status').textContent = "Status do DB: ERRO (Config)";
                return;
            }
            try {
                // setLogLevel('debug'); // Descomente para debug
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autentica√ß√£o
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('firebase-status').textContent = "Status do DB: Conectado. Carregando dados...";
                        setupFirestoreListeners();
                        // Garante que o bot√£o de setup pode ser usado se o usu√°rio for o administrador
                        document.getElementById('setup-data-btn').disabled = false;
                    } else {
                        console.log("Usu√°rio deslogado. Firestore n√£o iniciado.");
                        document.getElementById('firebase-status').textContent = "Status do DB: Desconectado.";
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                document.getElementById('firebase-status').textContent = "Status do DB: ERRO (Auth)";
            }
        };

        /**
         * Configura listeners em tempo real (onSnapshot) para Pre√ßo e Cupons.
         */
        const setupFirestoreListeners = () => {
            if (!db || !isAuthReady) return;

            // 1. Listener para Configura√ß√£o do Produto (Pre√ßo Base)
            onSnapshot(doc(db, CONFIG_DOC_PATH), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const config = docSnapshot.data();
                    originalPrice = config.basePrice || 0.00;
                    document.getElementById('product-name').textContent = config.productName || 'Produto SLAP';
                    
                    const featuresUl = document.getElementById('product-features');
                    featuresUl.innerHTML = '';
                    if (Array.isArray(config.productFeatures)) {
                        config.productFeatures.forEach(feature => {
                            const li = document.createElement('li');
                            li.textContent = feature;
                            featuresUl.appendChild(li);
                        });
                    }
                    
                    updateTotalPrice();
                    document.getElementById('firebase-status').textContent = `Status do DB: Carregado. Pre√ßo base: ${formatCurrency(originalPrice)}`;
                } else {
                    // Se o documento n√£o existir, mostrar bot√£o de setup
                    console.warn("Documento de configura√ß√£o n√£o encontrado. Clique em 'Configurar...'");
                    document.getElementById('admin-setup-box').classList.remove('hidden');
                    document.getElementById('firebase-status').textContent = "Status do DB: Aguardando Configura√ß√£o Inicial.";
                }
            }, (error) => {
                console.error("Erro ao ler Configura√ß√£o:", error);
                document.getElementById('firebase-status').textContent = "Status do DB: ERRO ao ler Configura√ß√£o.";
            });
            
            // 2. Listener para Cupons
            onSnapshot(collection(db, COUPONS_COLLECTION_PATH), (snapshot) => {
                COUPON_DATA = {};
                if (snapshot.empty) {
                    console.log("Nenhum cupom encontrado.");
                    // document.getElementById('admin-setup-box').classList.remove('hidden'); // Deixa vis√≠vel se n√£o h√° pre√ßo
                    return;
                }

                snapshot.forEach(doc => {
                    const couponCode = doc.id;
                    COUPON_DATA[couponCode] = doc.data();
                });
                console.log("Cupons carregados:", Object.keys(COUPON_DATA));
                // document.getElementById('admin-setup-box').classList.add('hidden'); // Esconde ap√≥s carregar
            }, (error) => {
                console.error("Erro ao ler Cupons:", error);
            });
        };

        /**
         * Fun√ß√£o para inserir pre√ßo e cupons de teste no Firestore (apenas para setup inicial).
         * CORRE√á√ÉO: Adicionado async/await e ajuste na desativa√ß√£o do bot√£o.
         */
        window.setInitialData = async () => {
            if (!db || !isAuthReady) {
                alert("O Firebase ainda n√£o est√° pronto. Tente novamente.");
                console.error("Firebase n√£o est√° pronto ou n√£o autenticado.");
                return;
            }
            try {
                const setupButton = document.getElementById('setup-data-btn');
                setupButton.disabled = true;
                setupButton.innerHTML = '<span class="spinner"></span> Configurando...';

                // 1. Configura√ß√£o do Produto
                await setDoc(doc(db, CONFIG_DOC_PATH), {
                    basePrice: 500.00,
                    productName: "Curso Completo de Marketing Digital SLAP",
                    productFeatures: [
                        "Acesso vital√≠cio ao conte√∫do",
                        "30 horas de aulas em v√≠deo",
                        "Certificado de Conclus√£o (SLAP)",
                        "Suporte priorit√°rio por 1 ano"
                    ]
                });

                // 2. Cupons de Teste
                await setDoc(doc(db, COUPONS_COLLECTION_PATH, 'SLAP10'), { 
                    type: 'percentage', 
                    value: 0.10, 
                    description: '10% de desconto no SLAP!',
                    active: true 
                });
                await setDoc(doc(db, COUPONS_COLLECTION_PATH, 'SLAPFREE'), { 
                    type: 'fixed', 
                    value: 100.00, 
                    description: 'R$ 100,00 de desconto fixo!',
                    active: true 
                });
                
                // alert('Dados iniciais de pre√ßo e cupons inseridos com sucesso no Firestore!');
            } catch (error) {
                console.error("Erro ao configurar dados iniciais:", error);
                alert('Erro ao configurar dados: ' + error.message);
            } finally {
                const setupButton = document.getElementById('setup-data-btn');
                setupButton.disabled = false;
                setupButton.textContent = "Configurar Pre√ßo e Cupons Iniciais";
            }
        };


        // ------------------------------------
        // FUN√á√ïES GERAIS E UTILS
        // ------------------------------------

        /**
         * Formata um n√∫mero como moeda brasileira (R$).
         */
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
            }).format(value);
        };
        
        /**
         * Atualiza as op√ß√µes de parcelamento na lista suspensa com base no pre√ßo final.
         * @param {number} price O pre√ßo total com desconto.
         */
        const updateInstallmentOptions = (price) => {
            const select = document.getElementById('installments');
            if (!select) return;

            select.innerHTML = '';
            
            // Defini√ß√µes de parcelas (Simula√ß√£o de juros/sem juros para display)
            // IMPORTANTE: O Asaas permite configurar essas taxas no backend
            const options = [
                { count: 1, text: '1x sem juros', factor: 1.0, monthly: price },
                { count: 2, text: '2x sem juros', factor: 1.0, monthly: price / 2 },
                { count: 3, text: '3x sem juros', factor: 1.0, monthly: price / 3 },
                // Simula√ß√£o com juros (ex: 10% em 6x, 15% em 12x)
                { count: 6, text: '6x c/ juros', factor: 1.10, monthly: (price * 1.10) / 6 }, 
                { count: 12, text: '12x c/ juros', factor: 1.15, monthly: (price * 1.15) / 12 }, 
            ];

            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.count;
                const monthlyPrice = (opt.monthly * opt.count < 0.01 && price > 0) ? formatCurrency(price) : formatCurrency(opt.monthly);
                option.textContent = `${opt.count}x - ${opt.text} (${monthlyPrice})`;
                select.appendChild(option);
            });
        };

        // ------------------------------------
        // L√ìGICA DE PRE√áOS E CUPONS (AGORA USA FIREBASE)
        // ------------------------------------

        /**
         * Aplica o cupom de desconto usando os dados carregados do Firestore.
         */
        window.applyCoupon = () => {
            const couponInput = document.getElementById('coupon-input');
            const couponCode = couponInput.value.toUpperCase().trim();
            const messageElement = document.getElementById('coupon-message');
            
            currentDiscount = 0;
            messageElement.className = 'mt-2 text-sm h-5';
            
            // AGORA USA COUPON_DATA DO FIREBASE
            const couponData = COUPON_DATA[couponCode];

            if (!couponData || !couponData.active) {
                messageElement.textContent = `üö´ Cupom "${couponCode}" inv√°lido ou inativo.`;
                messageElement.classList.add('text-red-500');
            } else {
                
                if (couponData.type === 'percentage') {
                    // Valor percentual (ex: 0.10 para 10%)
                    currentDiscount = originalPrice * couponData.value; 
                } else if (couponData.type === 'fixed') {
                    // Valor fixo (ex: 50.00)
                    currentDiscount = couponData.value;
                }

                currentDiscount = Math.min(currentDiscount, originalPrice); // Desconto m√°ximo √© o pre√ßo original
                
                messageElement.textContent = `‚úÖ Cupom aplicado! (${couponData.description})`;
                messageElement.classList.add('text-green-500'); 
            }

            updateTotalPrice();
        };

        /**
         * Recalcula o pre√ßo final e atualiza todos os displays e op√ß√µes de parcelamento.
         */
        const updateTotalPrice = () => {
            finalPrice = originalPrice - currentDiscount;

            // Atualiza os displays
            document.getElementById('original-price-display').textContent = formatCurrency(originalPrice);
            document.getElementById('discount-display').textContent = `- ${formatCurrency(currentDiscount)}`;
            document.getElementById('total-price-display').textContent = formatCurrency(finalPrice);
            
            // Atualiza as op√ß√µes de parcelamento com o novo pre√ßo
            updateInstallmentOptions(finalPrice);
            
            // L√≥gica de bot√£o para pedido gratuito
            const btnDesktop = document.getElementById('payment-button-desktop');
            const btnMobile = document.getElementById('payment-button-mobile');

            [btnDesktop, btnMobile].forEach(btn => {
                if (finalPrice <= 0) {
                    btn.textContent = "Finalizar Pedido (Gr√°tis)";
                    btn.classList.remove('bg-blue-600');
                    btn.classList.add('bg-indigo-600');
                } else {
                    btn.textContent = 'Gerar Pagamento Asaas';
                    btn.classList.remove('bg-indigo-600');
                    btn.classList.add('bg-blue-600');
                }
            });
        };

        /**
         * Fun√ß√£o principal de pagamento que envia os dados para o backend seguro.
         */
        window.handlePayment = async () => {
            const btnDesktop = document.getElementById('payment-button-desktop');
            const btnMobile = document.getElementById('payment-button-mobile');
            const statusContainerDesktop = document.getElementById('status-message-container-desktop');
            const statusContainerMobile = document.getElementById('status-message-container-mobile');
            const statusMessageDesktop = document.getElementById('status-message-desktop');
            const statusMessageMobile = document.getElementById('status-message-mobile');

            // --- 1. COLETA E VALIDA√á√ÉO DOS DADOS DO CLIENTE ---
            const customerName = document.getElementById('customer-name').value.trim();
            const customerEmail = document.getElementById('customer-email').value.trim();
            const customerCpf = document.getElementById('customer-cpf').value.trim();
            const customerDob = document.getElementById('customer-dob').value.trim(); 
            const selectedMethod = document.querySelector('input[name="payment-method"]:checked').value;
            
            let installments = 1; 

            if (selectedMethod === 'CREDIT_CARD') {
                 installments = parseInt(document.getElementById('installments').value, 10);
            }


            if (!customerName || !customerEmail || !customerCpf || !customerDob) {
                const msg = '‚ùå Por favor, preencha todos os campos obrigat√≥rios (Nome, E-mail, CPF e Data de Nascimento).';
                [statusMessageDesktop, statusMessageMobile].forEach(el => el.textContent = msg);
                [statusContainerDesktop, statusContainerMobile].forEach(el => {
                    el.classList.remove('hidden', 'bg-green-900/50', 'bg-zinc-700');
                    el.classList.add('block', 'bg-red-900/50', 'text-red-300'); 
                });
                return;
            }

            // Limpa e prepara o status
            [statusContainerDesktop, statusContainerMobile].forEach(el => el.classList.add('hidden'));
            const originalButtonText = btnDesktop.textContent;

            [btnDesktop, btnMobile].forEach(btn => {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> Gerando Cobran√ßa...';
            });
            
            const couponCode = document.getElementById('coupon-input').value.toUpperCase().trim();
            const valueToSend = finalPrice > 0 ? finalPrice : 0.01; 

            // --- 2. MONTA O PAYLOAD COMPLETO PARA O BACKEND ---
            const backendPayload = {
                customer: {
                    name: customerName,
                    email: customerEmail,
                    cpfCnpj: customerCpf,
                    dateOfBirth: customerDob, 
                },
                payment: {
                    billingType: selectedMethod, 
                    value: valueToSend,
                    dueDate: new Date(Date.now() + 86400000).toISOString().split('T')[0],
                    description: document.getElementById('product-name').textContent,
                    installmentCount: installments, 
                },
                appliedDiscount: {
                    originalPrice: originalPrice,
                    discountAmount: currentDiscount,
                    couponCode: couponCode,
                }
            };

            console.log('Payload enviado para o endpoint:', backendPayload);
            
            try {
                // CHAMADA REAL PARA O SEU ENDPOINT DO NETLIFY
                const response = await fetch(ASAAS_BACKEND_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(backendPayload),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Erro do Servidor: ${response.status}`);
                }
                
                const asaasResponse = await response.json();

                if (asaasResponse.success) {
                    const msg = `‚úÖ Cobran√ßa gerada (${asaasResponse.paymentMethod})! <br> <a href="${asaasResponse.invoiceUrl}" target="_blank" class="text-blue-400 hover:text-blue-300 font-bold underline">Clique aqui para Pagar</a>.`;
                    [statusMessageDesktop, statusMessageMobile].forEach(el => el.innerHTML = msg);
                    [statusContainerDesktop, statusContainerMobile].forEach(el => {
                        el.classList.remove('bg-red-900/50', 'bg-zinc-700');
                        el.classList.add('bg-green-900/50', 'text-green-300', 'block');
                    });
                } else {
                    throw new Error(asaasResponse.message || 'Falha ao processar pagamento no Asaas.');
                }

            } catch (error) {
                console.error('Erro no pagamento:', error);
                const msg = `‚ùå Erro ao gerar pagamento: ${error.message}.`;
                [statusMessageDesktop, statusMessageMobile].forEach(el => el.textContent = msg);
                [statusContainerDesktop, statusContainerMobile].forEach(el => {
                    el.classList.remove('bg-green-900/50', 'bg-zinc-700');
                    el.classList.add('bg-red-900/50', 'text-red-300', 'block');
                });
            } finally {
                [btnDesktop, btnMobile].forEach(btn => {
                    btn.disabled = false;
                    btn.textContent = originalButtonText;
                });
            }
        };

        // --- Event Listeners para Parcelas ---
        document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
            radio.addEventListener('change', (event) => {
                const installmentsSection = document.getElementById('installments-section');
                if (event.target.value === 'CREDIT_CARD' && event.target.checked) {
                    installmentsSection.classList.remove('hidden');
                } else {
                    installmentsSection.classList.add('hidden');
                }
            });
        });

        // --- Inicializa√ß√£o ---
        window.onload = initializeFirebase;
        
    </script>
</body>
</html>
